<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<script type="text/javascript">

function sendData()
{
	connection.send(document.output.doSay.value);
}

function acceptConnection()
{
	connection.accept(document.output.say.value);
	document.output.theButton.disabled = true;
	document.output.theRButton.disabled = true;
	document.output.innerHTML += "<br/><input type=\"text\" name=\"doSay\"/><input type=\"button\" onclick=\"sendData();\" value=\"Say\"/><br/>"
}

function rejectConnection()
{
	document.output.theButton.disabled = true;
	document.output.theRButton.disabled = true;
	connection.reject(document.output.say.value);
}

function pump() {
	var event = iface.getNextEvent();
	if(!event.eventType)
		return;
		
	console.log(event.eventType);
	
	if(event.eventType == plugin.torque.event.CONNECTION_REQUESTED_EVENT_TYPE)
	{
		connection = event.sourceConnection;
		var req = "Connection requested from " + event.sourceAddress + ".  It says " + event.data + "<br/>Reply: <input type=\"text\" name=\"say\"/><br/><input type=\"button\" onclick=\"acceptConnection();\" name=\"theButton\" value=\"Accept\"/><input type=\"button\" onclick=\"rejectConnection();\" name=\"theRButton\" value=\"Reject\"/>"
		document.output.innerHTML = req;
	}
	
	if(event.eventType == plugin.torque.event.CONNECTION_ACCEPTED_EVENT_TYPE)
	{
		document.output.innerHTML = "Connection accepted.  " + event.data;
		document.output.innerHTML += "<br/><input type=\"text\" name=\"doSay\"/><input type=\"button\" onclick=\"sendData();\" value=\"Say\"/><br/>"
	}
	
	if(event.eventType == plugin.torque.event.CONNECTION_REJECTED_EVENT_TYPE)
	{
		document.output.innerHTML = "Connection rejected from.  " + event.data;
	}
	
	if(event.eventType == plugin.torque.event.CONNECTION_DISCONNECTED_EVENT_TYPE)
	{
		document.output.innerHTML += "Connection closed, " + event.data + "<br/>";
	}
	
	if(event.eventType == plugin.torque.event.CONNECTION_PACKET_EVENT_TYPE)
	{
		document.output.innerHTML += event.data + "<br/>";
	}
}

function init() {
	if(document.params.addy.value == '')
	{
		document.getElementById("output").innerHTML = "Please enter a valid address";
		return;
	}
	
	document.getElementById("output").innerHTML = "";
	
	document.params.theButton.disabled = true;
	var connType = '';
	for(i = 0; i < document.params.connType.length; i++)
	{
		if(document.params.connType[i].checked)
		{
			connType = document.params.connType[i].value;
			break;
		}
	}
	
	isServer = connType == 'Server';

	plugin = document.getElementById("plugin");
	iface = plugin.torque.socket(document.params.addy.value);
	if (!iface) {
	alert("no plugin");
	}

	iface.allowIncomingConnections = isServer;
	
	setInterval('pump()', 32);
	
	if(!isServer)
	{
		document.params.innerHTML = "Connect to address: <input type=\"text\" name=\"addy\"/><br/>And say:<input type=\"text\" name=\"say\"/><br/><input type=\"button\" name=\"theButton\" onclick=\"connect()\" value=\"Connect!\">";
	}
}

function connect()
{
	if(document.params.addy.value == '')
	{
		document.getElementById("output").innerHTML = "Please enter a valid address";
		return;
	}
	
	document.getElementById("output").innerHTML = "";
	
	connection = iface.connect(document.params.addy.value, document.params.say.value);
	
	document.params.theButton.disabled = true;
}

</script>

</head>

<body>
<object type="application/x-torque-network-platform-debug" id="plugin" width="0" height="0"> </object><br/>
<form name="params">
I am a:
<input type="radio" name="connType" value="Server" checked>Server
<input type="radio" name="connType" value="Client">Client
<br/>
Bound to the address <input type="text" id="addy" name="addy" /><br/>

<input type="button" name="theButton" onclick="init()" value="Go!">
</form>

<form name="output" id="output"></form>

</body>
</html>