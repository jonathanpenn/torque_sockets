<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
</head>
<body>
<object type="application/x-torque-socket" id="plugin" width="0" height="0"> </object>
<script type="text/javascript">

var socket;
var plugin;
var connection = 0;

function clear_output()
{
	document.output.innerHTML = "";
}

function output(str)
{
	document.output.innerHTML += str + "<br/>";
}

function on_challenge_response(the_connection, key, message)
{
	output("Connection " + the_connection + " got a challenge response: " + message);
	socket.accept_challenge(the_connection);
}

function on_connect_request(the_connection, key, message)
{
	output("Incoming connection request " + the_connection + ": " + message);
	socket.accept_connection(the_connection);
	connection = the_connection;
}

function on_established(the_connection)
{
	output("Connection " + the_connection + " established.");
	document.chat_section.say_button.disabled = false;
	document.chat_section.chat_text.disabled = false;
}

function on_close(the_connection, reason)
{
}

function on_packet(the_connection, sequence, packet)
{
	output("Received message: " + packet + ", seq = " + sequence + " connection " + the_connection);
}

function on_packet_delivery_notify(the_connection, send_sequence, delivery_status)
{
	var result;
	if(delivery_status)
		result = " made it!";
	else
		result = " was dropped :(.";
	output("Packet " + send_sequence + " on connection " + the_connection + result);
}

function bind()
{
	if(document.bind_section.bind_address.value == '')
	{
		output("Please enter a valid address");
		return;
	}

	plugin = document.getElementById("plugin");
	socket = plugin.create_torque_socket();//(document.params.addy.value);
	socket.on_challenge_response = on_challenge_response;
	socket.on_connect_request = on_connect_request;
	socket.on_established = on_established;
	socket.on_close = on_close;
	socket.on_packet = on_packet;
	socket.on_packet_delivery_notify = on_packet_delivery_notify;
	socket.bind(document.bind_section.bind_address.value);
	socket.set_challenge_response(document.bind_section.challenge_response.value);
	document.connection_section.innerHTML = "Connect to address: <input type=\"text\" name=\"connect_address\"/><br/>With request_data:<input type=\"text\" name=\"request_data\"/><br/><input type=\"button\" name=\"connect_button\" onclick=\"connect()\" value=\"Connect!\">";
}

function connect()
{
	if(document.connection_section.connect_address.value == '')
	{
		output("Please enter a valid address");
		return;
	}
	clear_output();
	connection = socket.connect(document.connection_section.connect_address.value, document.connection_section.request_data.value, "");
	output("Connecting to host " + document.connection_section.connect_address.value + ", connection = " + connection);
	
	document.connection_section.connect_button.disabled = true;
}

function say()
{
	var seq = socket.send_to(connection, document.chat_section.chat_text.value);
	output("Sent message: " + document.chat_section.chat_text.value + ", seq = " + seq);
}

</script>
<form name="bind_section">
	Bind TorqueSocket to address <input type="text" id="bind_address" name="bind_address"/><br/>
	With challenge response <input type="text" id="challenge_response" name="challenge_response"/><br/>
	<input type="button" name="bind_button" onclick="bind()" value="Bind"/>
</form>

<form name="connection_section" id="connection_section">
</form>

<form name="chat_section" id = "chat_section">
	Say <input type="text" disabled = true id = "chat_text" name = "chat_text"/>
	<input type="button" disabled = true name="say_button" onclick="say()" value="Send"/>
</form>

<form name="output" id="output"></form>
</body>
</html>